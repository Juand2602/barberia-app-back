generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CLIENTES ====================
model Cliente {
  id              String   @id @default(uuid())
  nombre          String
  telefono        String   @unique
  email           String?
  fechaRegistro   DateTime @default(now())
  notas           String?
  activo          Boolean  @default(true)
  
  // ðŸŒŸ NUEVO: Sistema de Sellos
  sellos          Int      @default(0)
  sellosCanjeados Int      @default(0)
  ultimoSello     DateTime?
  
  citas           Cita[]
  conversaciones  Conversacion[]
  transacciones   Transaccion[]
  historialSellos HistorialSello[]  // ðŸŒŸ NUEVO
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([telefono])
  @@index([nombre])
  @@index([sellos])
}

// ==================== HISTORIAL DE SELLOS ====================
// ðŸŒŸ NUEVO: Tabla para tracking de sellos
model HistorialSello {
  id          String   @id @default(uuid())
  clienteId   String
  tipo        String   // "AGREGADO" | "CANJEADO"
  cantidad    Int      // CuÃ¡ntos sellos se agregaron/canjearon
  motivo      String?  // Ej: "Corte completado", "Premio canjeado: Corte gratis"
  sellosTotales Int    // Saldo despuÃ©s de esta operaciÃ³n
  usuarioId   String?  // QuiÃ©n hizo la operaciÃ³n (opcional)
  
  cliente     Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@index([clienteId, createdAt])
  @@index([tipo])
}

// ==================== CONFIGURACIÃ“N PREMIOS ====================
// ðŸŒŸ NUEVO: Para configurar los premios
model ConfiguracionPremio {
  id              String   @id @default(uuid())
  nombre          String   // Ej: "Corte Gratis"
  sellosRequeridos Int     // Cantidad de sellos necesarios
  descripcion     String?
  activo          Boolean  @default(true)
  orden           Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([activo, orden])
}

// ==================== EMPLEADOS ====================
model Empleado {
  id              String   @id @default(uuid())
  nombre          String
  telefono        String
  fotoUrl         String?
  especialidades  String
  activo          Boolean  @default(true)
  fechaIngreso    DateTime @default(now())
  porcentajeComision Float @default(50.0)
  
  // IntegraciÃ³n con Google Calendar
  googleCalendarId    String?
  googleAccessToken   String?  @db.Text
  googleRefreshToken  String?  @db.Text
  googleTokenExpiry   DateTime?
  calendarioSincronizado Boolean @default(false)
  
  horarioLunes    String?
  horarioMartes   String?
  horarioMiercoles String?
  horarioJueves   String?
  horarioViernes  String?
  horarioSabado   String?
  horarioDomingo  String?
  
  citas           Cita[]
  transacciones   Transaccion[]
  pagosComision   PagoComision[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([activo])
  @@index([calendarioSincronizado])
}

// ==================== SERVICIOS ====================
model Servicio {
  id              String   @id @default(uuid())
  nombre          String
  descripcion     String?
  precio          Float
  duracionMinutos Int
  activo          Boolean  @default(true)
  
  items           TransaccionItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([activo])
}

// ==================== CITAS ====================
model Cita {
  id              String   @id @default(uuid())
  radicado        String   @unique
  clienteId       String
  empleadoId      String
  servicioNombre  String
  fechaHora       DateTime
  duracionMinutos Int
  estado          String   @default("PENDIENTE")
  origen          String   @default("WHATSAPP")
  notas           String?
  motivoCancelacion String?
  
  googleEventId   String?
  
  cliente         Cliente  @relation(fields: [clienteId], references: [id])
  empleado        Empleado @relation(fields: [empleadoId], references: [id])
  transacciones   Transaccion[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([fechaHora])
  @@index([radicado])
  @@index([empleadoId, fechaHora])
  @@index([estado])
  @@index([googleEventId])
}

// ==================== CONVERSACIONES (CONTEXTO BOT) ====================
model Conversacion {
  id              String   @id @default(uuid())
  clienteId       String
  telefono        String
  estado          String   @default("INICIAL")
  contexto        String
  lastActivity    DateTime @default(now())
  activa          Boolean  @default(true)
  
  cliente         Cliente  @relation(fields: [clienteId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([telefono, activa])
  @@index([lastActivity])
}

// ==================== TRANSACCIONES ====================
model Transaccion {
  id              String   @id @default(uuid())
  tipo            String
  clienteId       String?
  empleadoId      String?
  citaId          String?
  fecha           DateTime @default(now())
  total           Float
  metodoPago      String
  estadoPago      String   @default("PENDIENTE")
  referencia      String?
  concepto        String?
  categoria       String?
  notas           String?
  
  items           TransaccionItem[]
  cliente         Cliente? @relation(fields: [clienteId], references: [id])
  empleado        Empleado? @relation(fields: [empleadoId], references: [id])
  cita            Cita? @relation(fields: [citaId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([fecha])
  @@index([tipo, fecha])
  @@index([metodoPago])
  @@index([estadoPago])
  @@index([citaId])
  @@index([empleadoId, estadoPago, tipo])
}

model TransaccionItem {
  id              String      @id @default(uuid())
  transaccionId   String
  servicioId      String
  cantidad        Int         @default(1)
  precioUnitario  Float
  subtotal        Float
  
  transaccion     Transaccion @relation(fields: [transaccionId], references: [id], onDelete: Cascade)
  servicio        Servicio    @relation(fields: [servicioId], references: [id])
  
  createdAt       DateTime    @default(now())
  
  @@index([transaccionId])
}

// ==================== PAGOS DE COMISIÃ“N ====================
model PagoComision {
  id              String   @id @default(uuid())
  empleadoId      String
  periodo         String
  fechaPago       DateTime @default(now())
  fechaInicio     DateTime
  fechaFin        DateTime
  totalVentas     Float
  porcentaje      Float
  montoComision   Float
  montoPagado     Float
  diferencia      Float
  metodoPago      String
  referencia      String?
  notas           String?
  transaccionIds  String
  cantidadTransacciones Int
  
  empleado        Empleado @relation(fields: [empleadoId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([empleadoId, periodo])
  @@index([empleadoId, fechaPago])
  @@index([periodo])
}

// ==================== CIERRE DE CAJA ====================
model CierreCaja {
  id                String   @id @default(uuid())
  fecha             DateTime @default(now())
  efectivoInicial   Float
  efectivoFinal     Float
  efectivoEsperado  Float
  ingresos          Float
  egresos           Float
  diferencia        Float
  totalTransferencias Float
  notas             String?
  
  createdAt         DateTime @default(now())
  
  @@index([fecha])
}

// ==================== CONFIGURACIÃ“N ====================
model Configuracion {
  id                String   @id @default(uuid())
  clave             String   @unique
  valor             String
  descripcion       String?
  
  updatedAt         DateTime @updatedAt
}

model AperturaCaja {
  id           String   @id @default(uuid())
  usuarioId    Int?
  fecha        DateTime @default(now())
  montoInicial Float
  estado       String   @default("ABIERTA")
  notas        String? 
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([usuarioId])
}